<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="API references" href="../../pages/api_references.html" /><link rel="prev" title="Using a validation set to monitor the convergence of the fugw loss" href="plot_2_simple_crossval.html" />

    <!-- Generated with Sphinx 5.3.0 and Furo 2023.03.27 -->
        <title>Monitor memory usage at each BCD iteration with callbacks - FUGW</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #232629;
  --color-code-foreground: #cccccc;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #232629;
  --color-code-foreground: #cccccc;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">FUGW</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">FUGW</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../pages/introduction.html">Introduction</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../index.html">Examples</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 has-children"><a class="reference internal" href="../00_basics/index.html">Basics</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../00_basics/plot_1_dense.html">Transport distributions using dense solvers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../00_basics/plot_2_1_lmds.html">Generate embeddings from mesh</a></li>
<li class="toctree-l3"><a class="reference internal" href="../00_basics/plot_2_2_coarse_to_fine.html">Transport distributions using sparse solvers</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../01_brain_alignment/index.html">Brain alignment</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../01_brain_alignment/plot_1_aligning_brain_dense.html">Low-resolution surface alignment of 2 individuals with fMRI data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../01_brain_alignment/plot_2_aligning_brain_sparse.html">High-resolution surface alignment of 2 individuals with fMRI data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../01_brain_alignment/plot_3_aligning_low_res_volumes.html">Low-resolution volume alignment of 2 individuals with fMRI data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../01_brain_alignment/plot_4_aligning_high_res_volumes.html">High-resolution volume alignment of 2 individuals with fMRI data</a></li>
</ul>
</li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="index.html">Miscellaneous</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="plot_1_pearson_correlation.html">Monitor the Pearson correlation during training with callbacks</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_2_simple_crossval.html">Using a validation set to monitor the convergence of the fugw loss</a></li>
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">Monitor memory usage at each BCD iteration with callbacks</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../pages/api_references.html">API references</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../pages/mappings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">fugw.mappings</span></code></a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../pages/generated/fugw.mappings.FUGW.html">fugw.mappings.FUGW</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../pages/generated/fugw.mappings.FUGWSparse.html">fugw.mappings.FUGWSparse</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../pages/solvers.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">fugw.solvers</span></code></a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../pages/generated/fugw.solvers.FUGWSolver.html">fugw.solvers.FUGWSolver</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../pages/generated/fugw.solvers.FUGWSparseSolver.html">fugw.solvers.FUGWSparseSolver</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../pages/utils.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">fugw.utils</span></code></a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../pages/contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/alexisthual/fugw">GitHub repository</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-examples-02-miscellaneous-plot-3-memory-usage-callback-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="monitor-memory-usage-at-each-bcd-iteration-with-callbacks">
<span id="sphx-glr-auto-examples-02-miscellaneous-plot-3-memory-usage-callback-py"></span><h1>Monitor memory usage at each BCD iteration with callbacks<a class="headerlink" href="#monitor-memory-usage-at-each-bcd-iteration-with-callbacks" title="Permalink to this heading">#</a></h1>
<p>In this example, we use a callback function to monitor memory usage
at each iteration of the block-coordinate descent (BCD) algorithm.
This can be useful to detect memory leaks, or to check that the
memory usage is not too high for a given device.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">fugw.mappings</span> <span class="kn">import</span> <a href="../../pages/generated/fugw.mappings.FUGW.html#fugw.mappings.FUGW" title="fugw.mappings.FUGW" class="sphx-glr-backref-module-fugw-mappings sphx-glr-backref-type-py-class"><span class="n">FUGW</span></a>
<span class="kn">from</span> <span class="nn">fugw.utils</span> <span class="kn">import</span> <span class="n">_init_mock_distribution</span>
<span class="kn">from</span> <span class="nn">rich.console</span> <span class="kn">import</span> <span class="n">Console</span>
<span class="kn">from</span> <span class="nn">rich.table</span> <span class="kn">import</span> <span class="n">Table</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">n_points_source</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">n_points_target</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">n_features_train</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">n_features_test</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
<p>Let us generate random training data for the source and target distributions</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="../../pages/generated/fugw.mappings.FUGW.html#fugw.mappings.FUGW" title="fugw.mappings.FUGW" class="sphx-glr-backref-module-fugw-mappings sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">_</span></a><span class="p">,</span> <span class="n">source_features_train</span><span class="p">,</span> <span class="n">source_geometry</span><span class="p">,</span> <a href="../../pages/generated/fugw.mappings.FUGW.html#fugw.mappings.FUGW" title="fugw.mappings.FUGW" class="sphx-glr-backref-module-fugw-mappings sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">_</span></a> <span class="o">=</span> <span class="n">_init_mock_distribution</span><span class="p">(</span>
    <span class="n">n_features_train</span><span class="p">,</span> <span class="n">n_points_source</span>
<span class="p">)</span>
<a href="../../pages/generated/fugw.mappings.FUGW.html#fugw.mappings.FUGW" title="fugw.mappings.FUGW" class="sphx-glr-backref-module-fugw-mappings sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">_</span></a><span class="p">,</span> <span class="n">target_features_train</span><span class="p">,</span> <span class="n">target_geometry</span><span class="p">,</span> <a href="../../pages/generated/fugw.mappings.FUGW.html#fugw.mappings.FUGW" title="fugw.mappings.FUGW" class="sphx-glr-backref-module-fugw-mappings sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">_</span></a> <span class="o">=</span> <span class="n">_init_mock_distribution</span><span class="p">(</span>
    <span class="n">n_features_train</span><span class="p">,</span> <span class="n">n_points_target</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.8/site-packages/torch/distributions/wishart.py:271: UserWarning:

Singular sample detected.
</pre></div>
</div>
<p>Features and geometries should be normalized before calling the solver</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source_features_train_normalized</span> <span class="o">=</span> <span class="n">source_features_train</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
    <span class="n">source_features_train</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">target_features_train_normalized</span> <span class="o">=</span> <span class="n">target_features_train</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
    <span class="n">target_features_train</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">source_geometry_normalized</span> <span class="o">=</span> <span class="n">source_geometry</span> <span class="o">/</span> <span class="n">source_geometry</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">target_geometry_normalized</span> <span class="o">=</span> <span class="n">target_geometry</span> <span class="o">/</span> <span class="n">target_geometry</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
<p>We define a function to check memory usage at each iteration of the BCD
algorithm, as well as util functions to print relevant information.
In short, fugw callback functions receive <cite>locals()</cite>, which is a dictionary
of all local variables in the current scope.
This allows us to access the tensors that are used in the BCD algorithm.
In particular, we filter our tensors that are on our device of interest,
and we compute their respective memory usage.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_sparse</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">layout</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;sparse&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">str_size</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;torch\.Size\(\[(.*)\]\)&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">str_mem</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;KB&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;KB&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mem</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="si">:</span><span class="s2">,.3f</span><span class="si">}</span><span class="s2"> KB&quot;</span>
    <span class="k">elif</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;MB&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mem</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="si">:</span><span class="s2">,.3f</span><span class="si">}</span><span class="s2"> MB&quot;</span>


<span class="k">def</span> <span class="nf">check_memory_usage</span><span class="p">(</span><span class="nb">locals</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)):</span>
    <span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span>

    <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">locals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="n">device</span><span class="p">:</span>
            <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>

    <span class="n">variables</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
    <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Variable&quot;</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Size&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Numel&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Memory allocated&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>

    <span class="n">memory_allocated</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_sparse</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
            <span class="n">numel</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_nnz</span><span class="p">()</span>
            <span class="n">var_memory_allocated</span> <span class="o">=</span> <span class="n">numel</span> <span class="o">*</span> <span class="n">value</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span>
            <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">str_size</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">numel</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">str_mem</span><span class="p">(</span><span class="n">var_memory_allocated</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
            <span class="n">numel</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
            <span class="n">var_memory_allocated</span> <span class="o">=</span> <span class="n">numel</span> <span class="o">*</span> <span class="n">value</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span>
            <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">str_size</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">numel</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">str_mem</span><span class="p">(</span><span class="n">var_memory_allocated</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">memory_allocated</span> <span class="o">+=</span> <span class="n">var_memory_allocated</span>

    <span class="n">table</span><span class="o">.</span><span class="n">add_section</span><span class="p">()</span>
    <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Total (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">str_mem</span><span class="p">(</span><span class="n">memory_allocated</span><span class="p">),</span>
        <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="n">memory_at_bcd_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memory_allocated</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">:</span>
        <span class="n">memory_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Memory allocated&quot;</span><span class="p">,</span> <span class="n">str_mem</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">))),</span>
            <span class="p">(</span><span class="s2">&quot;Memory cached&quot;</span><span class="p">,</span> <span class="n">str_mem</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_cached</span><span class="p">(</span><span class="n">device</span><span class="p">))),</span>
            <span class="p">(</span><span class="s2">&quot;Memory reserved&quot;</span><span class="p">,</span> <span class="n">str_mem</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">))),</span>
        <span class="p">]</span>
        <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">memory_lines</span><span class="p">))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>Let us define the optimization problem to solve</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">rho</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-4</span>
<a href="../../pages/generated/fugw.mappings.FUGW.html#fugw.mappings.FUGW" title="fugw.mappings.FUGW" class="sphx-glr-backref-module-fugw-mappings sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">mapping</span></a> <span class="o">=</span> <a href="../../pages/generated/fugw.mappings.FUGW.html#fugw.mappings.FUGW" title="fugw.mappings.FUGW" class="sphx-glr-backref-module-fugw-mappings sphx-glr-backref-type-py-class"><span class="n">FUGW</span></a><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, we fit a transport plan between source and target distributions
using a sinkhorn solver.
Our callback function will be called at each iteration of the BCD algorithm.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">memory_at_bcd_step</span> <span class="o">=</span> <span class="p">[]</span>

<a href="../../pages/generated/fugw.mappings.FUGW.html#fugw.mappings.FUGW" title="fugw.mappings.FUGW" class="sphx-glr-backref-module-fugw-mappings sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">_</span></a> <span class="o">=</span> <a href="../../pages/generated/fugw.mappings.FUGW.html#fugw.mappings.FUGW.fit" title="fugw.mappings.FUGW.fit" class="sphx-glr-backref-module-fugw-mappings sphx-glr-backref-type-py-method"><span class="n">mapping</span><span class="o">.</span><span class="n">fit</span></a><span class="p">(</span>
    <span class="n">source_features_train_normalized</span><span class="p">,</span>
    <span class="n">target_features_train_normalized</span><span class="p">,</span>
    <span class="n">source_geometry</span><span class="o">=</span><span class="n">source_geometry_normalized</span><span class="p">,</span>
    <span class="n">target_geometry</span><span class="o">=</span><span class="n">target_geometry_normalized</span><span class="p">,</span>
    <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;sinkhorn&quot;</span><span class="p">,</span>
    <span class="n">solver_params</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;nits_bcd&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;nits_uot&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">callback_bcd</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">check_memory_usage</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span>
    <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[11:55:35] Validation data for feature maps is not provided. Using  dense.py:199
           training data instead.
           Validation data for anatomical kernels is not provided.  dense.py:226
           Using training data instead.


           BCD step 1/5    FUGW loss:      15.441089630126953       dense.py:521
           Validation loss:        15.441089630126953
┏━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┳━━━━━━━━━━━━━━━━━━┓
┃ Variable   ┃   Size ┃ Numel ┃ Memory allocated ┃
┡━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━╇━━━━━━━━━━━━━━━━━━┩
│ cost_gamma │ 50, 40 │ 2,000 │         7.812 KB │
│ cost_pi    │ 50, 40 │ 2,000 │         7.812 KB │
│ Ds         │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_sqr     │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_sqr_val │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_val     │ 50, 50 │ 2,500 │         9.766 KB │
│ Dt         │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_sqr     │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_sqr_val │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_val     │ 40, 40 │ 1,600 │         6.250 KB │
│ F          │ 50, 40 │ 2,000 │         7.812 KB │
│ gamma      │ 50, 40 │ 2,000 │         7.812 KB │
│ init_plan  │ 50, 40 │ 2,000 │         7.812 KB │
│ mass_gamma │        │     1 │         0.004 KB │
│ mass_pi    │        │     1 │         0.004 KB │
│ new_eps    │        │     1 │         0.004 KB │
│ new_rho_s  │        │     1 │         0.004 KB │
│ new_rho_t  │        │     1 │         0.004 KB │
│ pi         │ 50, 40 │ 2,000 │         7.812 KB │
│ pi_prev    │ 50, 40 │ 2,000 │         7.812 KB │
│ ws         │     50 │    50 │         0.195 KB │
│ ws_dot_wt  │ 50, 40 │ 2,000 │         7.812 KB │
│ wt         │     40 │    40 │         0.156 KB │
├────────────┼────────┼───────┼──────────────────┤
│ Total (23) │        │       │       126.934 KB │
└────────────┴────────┴───────┴──────────────────┘


           BCD step 2/5    FUGW loss:      9.552192687988281        dense.py:521
           Validation loss:        9.552192687988281
┏━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┳━━━━━━━━━━━━━━━━━━┓
┃ Variable   ┃   Size ┃ Numel ┃ Memory allocated ┃
┡━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━╇━━━━━━━━━━━━━━━━━━┩
│ cost_gamma │ 50, 40 │ 2,000 │         7.812 KB │
│ cost_pi    │ 50, 40 │ 2,000 │         7.812 KB │
│ Ds         │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_sqr     │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_sqr_val │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_val     │ 50, 50 │ 2,500 │         9.766 KB │
│ Dt         │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_sqr     │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_sqr_val │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_val     │ 40, 40 │ 1,600 │         6.250 KB │
│ F          │ 50, 40 │ 2,000 │         7.812 KB │
│ gamma      │ 50, 40 │ 2,000 │         7.812 KB │
│ init_plan  │ 50, 40 │ 2,000 │         7.812 KB │
│ mass_gamma │        │     1 │         0.004 KB │
│ mass_pi    │        │     1 │         0.004 KB │
│ new_eps    │        │     1 │         0.004 KB │
│ new_rho_s  │        │     1 │         0.004 KB │
│ new_rho_t  │        │     1 │         0.004 KB │
│ pi         │ 50, 40 │ 2,000 │         7.812 KB │
│ pi_prev    │ 50, 40 │ 2,000 │         7.812 KB │
│ ws         │     50 │    50 │         0.195 KB │
│ ws_dot_wt  │ 50, 40 │ 2,000 │         7.812 KB │
│ wt         │     40 │    40 │         0.156 KB │
├────────────┼────────┼───────┼──────────────────┤
│ Total (23) │        │       │       126.934 KB │
└────────────┴────────┴───────┴──────────────────┘


           BCD step 3/5    FUGW loss:      5.377944469451904        dense.py:521
           Validation loss:        5.377944469451904
┏━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┳━━━━━━━━━━━━━━━━━━┓
┃ Variable   ┃   Size ┃ Numel ┃ Memory allocated ┃
┡━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━╇━━━━━━━━━━━━━━━━━━┩
│ cost_gamma │ 50, 40 │ 2,000 │         7.812 KB │
│ cost_pi    │ 50, 40 │ 2,000 │         7.812 KB │
│ Ds         │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_sqr     │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_sqr_val │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_val     │ 50, 50 │ 2,500 │         9.766 KB │
│ Dt         │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_sqr     │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_sqr_val │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_val     │ 40, 40 │ 1,600 │         6.250 KB │
│ F          │ 50, 40 │ 2,000 │         7.812 KB │
│ gamma      │ 50, 40 │ 2,000 │         7.812 KB │
│ init_plan  │ 50, 40 │ 2,000 │         7.812 KB │
│ mass_gamma │        │     1 │         0.004 KB │
│ mass_pi    │        │     1 │         0.004 KB │
│ new_eps    │        │     1 │         0.004 KB │
│ new_rho_s  │        │     1 │         0.004 KB │
│ new_rho_t  │        │     1 │         0.004 KB │
│ pi         │ 50, 40 │ 2,000 │         7.812 KB │
│ pi_prev    │ 50, 40 │ 2,000 │         7.812 KB │
│ ws         │     50 │    50 │         0.195 KB │
│ ws_dot_wt  │ 50, 40 │ 2,000 │         7.812 KB │
│ wt         │     40 │    40 │         0.156 KB │
├────────────┼────────┼───────┼──────────────────┤
│ Total (23) │        │       │       126.934 KB │
└────────────┴────────┴───────┴──────────────────┘


           BCD step 4/5    FUGW loss:      6.105615139007568        dense.py:521
           Validation loss:        6.105615139007568
┏━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┳━━━━━━━━━━━━━━━━━━┓
┃ Variable   ┃   Size ┃ Numel ┃ Memory allocated ┃
┡━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━╇━━━━━━━━━━━━━━━━━━┩
│ cost_gamma │ 50, 40 │ 2,000 │         7.812 KB │
│ cost_pi    │ 50, 40 │ 2,000 │         7.812 KB │
│ Ds         │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_sqr     │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_sqr_val │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_val     │ 50, 50 │ 2,500 │         9.766 KB │
│ Dt         │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_sqr     │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_sqr_val │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_val     │ 40, 40 │ 1,600 │         6.250 KB │
│ F          │ 50, 40 │ 2,000 │         7.812 KB │
│ gamma      │ 50, 40 │ 2,000 │         7.812 KB │
│ init_plan  │ 50, 40 │ 2,000 │         7.812 KB │
│ mass_gamma │        │     1 │         0.004 KB │
│ mass_pi    │        │     1 │         0.004 KB │
│ new_eps    │        │     1 │         0.004 KB │
│ new_rho_s  │        │     1 │         0.004 KB │
│ new_rho_t  │        │     1 │         0.004 KB │
│ pi         │ 50, 40 │ 2,000 │         7.812 KB │
│ pi_prev    │ 50, 40 │ 2,000 │         7.812 KB │
│ ws         │     50 │    50 │         0.195 KB │
│ ws_dot_wt  │ 50, 40 │ 2,000 │         7.812 KB │
│ wt         │     40 │    40 │         0.156 KB │
├────────────┼────────┼───────┼──────────────────┤
│ Total (23) │        │       │       126.934 KB │
└────────────┴────────┴───────┴──────────────────┘


           BCD step 5/5    FUGW loss:      7.274874210357666        dense.py:521
           Validation loss:        7.274874210357666
┏━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┳━━━━━━━━━━━━━━━━━━┓
┃ Variable   ┃   Size ┃ Numel ┃ Memory allocated ┃
┡━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━╇━━━━━━━━━━━━━━━━━━┩
│ cost_gamma │ 50, 40 │ 2,000 │         7.812 KB │
│ cost_pi    │ 50, 40 │ 2,000 │         7.812 KB │
│ Ds         │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_sqr     │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_sqr_val │ 50, 50 │ 2,500 │         9.766 KB │
│ Ds_val     │ 50, 50 │ 2,500 │         9.766 KB │
│ Dt         │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_sqr     │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_sqr_val │ 40, 40 │ 1,600 │         6.250 KB │
│ Dt_val     │ 40, 40 │ 1,600 │         6.250 KB │
│ F          │ 50, 40 │ 2,000 │         7.812 KB │
│ gamma      │ 50, 40 │ 2,000 │         7.812 KB │
│ init_plan  │ 50, 40 │ 2,000 │         7.812 KB │
│ mass_gamma │        │     1 │         0.004 KB │
│ mass_pi    │        │     1 │         0.004 KB │
│ new_eps    │        │     1 │         0.004 KB │
│ new_rho_s  │        │     1 │         0.004 KB │
│ new_rho_t  │        │     1 │         0.004 KB │
│ pi         │ 50, 40 │ 2,000 │         7.812 KB │
│ pi_prev    │ 50, 40 │ 2,000 │         7.812 KB │
│ ws         │     50 │    50 │         0.195 KB │
│ ws_dot_wt  │ 50, 40 │ 2,000 │         7.812 KB │
│ wt         │     40 │    40 │         0.156 KB │
├────────────┼────────┼───────┼──────────────────┤
│ Total (23) │        │       │       126.934 KB │
└────────────┴────────┴───────┴──────────────────┘
</pre></div>
</div>
<p>In this example, we see that fugw’s memory usage is constant.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure" title="matplotlib.figure.Figure" class="sphx-glr-backref-module-matplotlib-figure sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">fig</span></a> <span class="o">=</span> <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.figure.html#matplotlib.pyplot.figure" title="matplotlib.pyplot.figure" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span></a><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure.suptitle" title="matplotlib.figure.Figure.suptitle" class="sphx-glr-backref-module-matplotlib-figure sphx-glr-backref-type-py-method"><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span></a><span class="p">(</span><span class="s2">&quot;Memory usage at each BCD iteration&quot;</span><span class="p">)</span>

<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.html#matplotlib.axes.Axes" title="matplotlib.axes.Axes" class="sphx-glr-backref-module-matplotlib-axes sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ax</span></a> <span class="o">=</span> <a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure.add_subplot" title="matplotlib.figure.Figure.add_subplot" class="sphx-glr-backref-module-matplotlib-figure sphx-glr-backref-type-py-method"><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span></a><span class="p">()</span>
<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.set_xlabel.html#matplotlib.axes.Axes.set_xlabel" title="matplotlib.axes.Axes.set_xlabel" class="sphx-glr-backref-module-matplotlib-axes sphx-glr-backref-type-py-method"><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span></a><span class="p">(</span><span class="s2">&quot;BCD iteration&quot;</span><span class="p">)</span>
<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.set_xticks.html#matplotlib.axes.Axes.set_xticks" title="matplotlib.axes.Axes.set_xticks" class="sphx-glr-backref-module-matplotlib-axes sphx-glr-backref-type-py-method"><span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span></a><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">memory_at_bcd_step</span><span class="p">)))</span>
<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.set_ylabel.html#matplotlib.axes.Axes.set_ylabel" title="matplotlib.axes.Axes.set_ylabel" class="sphx-glr-backref-module-matplotlib-axes sphx-glr-backref-type-py-method"><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span></a><span class="p">(</span><span class="s2">&quot;Memory allocated (KB)&quot;</span><span class="p">)</span>
<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.plot.html#matplotlib.axes.Axes.plot" title="matplotlib.axes.Axes.plot" class="sphx-glr-backref-module-matplotlib-axes sphx-glr-backref-type-py-method"><span class="n">ax</span><span class="o">.</span><span class="n">plot</span></a><span class="p">(</span><span class="n">memory_at_bcd_step</span><span class="p">)</span>

<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="matplotlib.pyplot.show" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_3_memory_usage_callback_001.png" srcset="../../_images/sphx_glr_plot_3_memory_usage_callback_001.png" alt="Memory usage at each BCD iteration" class = "sphx-glr-single-img"/><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 1.840 seconds)</p>
<p><strong>Estimated memory usage:</strong>  8 MB</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-02-miscellaneous-plot-3-memory-usage-callback-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/5b83aa61e089b86824b89269b568f15e/plot_3_memory_usage_callback.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_3_memory_usage_callback.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/275a9983285f2255c331983fb14868ba/plot_3_memory_usage_callback.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_3_memory_usage_callback.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../../pages/api_references.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">API references</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="plot_2_simple_crossval.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Using a validation set to monitor the convergence of the fugw loss</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022-2023, the fugw team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/scripts/furo.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    </body>
</html>